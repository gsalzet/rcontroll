<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generate climate data • rcontroll</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Generate climate data">
<meta property="og:description" content="rcontroll">
<meta property="og:image" content="https://sylvainschmitt.github.io/rcontroll/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rcontroll</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/climate.html">Generate climate data</a>
    </li>
    <li>
      <a href="../articles/troll.html">The TROLL model</a>
    </li>
    <li>
      <a href="../articles/workflow.html">A simple workflow</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/sylvainschmitt/rcontroll/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="climate_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Generate climate data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/sylvainschmitt/rcontroll/blob/HEAD/vignettes/climate.Rmd" class="external-link"><code>vignettes/climate.Rmd</code></a></small>
      <div class="hidden name"><code>climate.Rmd</code></div>

    </div>

    
    
<p>TROLL forest simulator relies on climate tables with half-hourly variations of a typical day and monthly variations of a typical year which are recycled through simulation days and years. Initially, TROLL climate tables were computed from the Nouraflux dataset. Variations in quantities of interests (temperatures, …) were averaged to the target resolution (half-hour for daily variation or month for monthly variation). The purpose of climate generation functions is to compute equivalent climate tables from the ERA5 land reanalysis dataset. With these functions, rcontroll users only need inventories and associated functional traits to run TROLL simulations.</p>
<p>This vignette requires numerous packages (12) to work. Some are not integrated to <code>rcontroll</code>. Consequently, the chunks are not compiled. But we strongly encourage users that want to generate their climate data for TROLL to install all the packages and run manually this vignette. All the packages role is detailed below. Some may be avoided, only <code>ecmwfr</code> is mandatory to download the ERA5 land data from Copernicus and obviously <code>rcontroll</code> to convert the data to TROLL inputs.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bluegreen-labs/ecmwfr" class="external-link">ecmwfr</a></span><span class="op">)</span> <span class="co"># to request data from Copernicus</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/osmdata/" class="external-link">osmdata</a></span><span class="op">)</span> <span class="co"># to get bounding box from the study area</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/leaflet/" class="external-link">leaflet</a></span><span class="op">)</span> <span class="co"># to make interactive maps</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/" class="external-link">terra</a></span><span class="op">)</span> <span class="co"># to read the netCDF files</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span> <span class="co"># to deal with dates and times </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span> <span class="co"># to wrangle and tidy the data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span> <span class="co"># to wrangle and tidy the data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span> <span class="co"># to make statis maps</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gganimate.com" class="external-link">gganimate</a></span><span class="op">)</span> <span class="co"># to make a temporal gif of climate variation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dieghernan.github.io/nominatimlite/" class="external-link">nominatimlite</a></span><span class="op">)</span> <span class="co"># to get coordinates from the study area</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span> <span class="co"># to extract coordinates from spatial objects</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sylvainschmitt/rcontroll" class="external-link">rcontroll</a></span><span class="op">)</span> <span class="co"># to generate TROLL climate inputs</span></span></code></pre></div>
<div class="section level2">
<h2 id="download-era5-land-data">Download ERA5-land data<a class="anchor" aria-label="anchor" href="#download-era5-land-data"></a>
</h2>
<p>Before you will be able to download any data you need to get a free personal account and accept the licence to use both ECMWF and Copernicus data.</p>
<p>First ECMWF:</p>
<ul>
<li><a href="https://apps.ecmwf.int/registration/" class="external-link">Register yourself for ECMWF services</a></li>
</ul>
<p>Then Copernicus:</p>
<ul>
<li><a href="https://cds.climate.copernicus.eu/user/register" class="external-link">Register yourself for CDS services</a></li>
<li><a href="https://cds.climate.copernicus.eu/cdsapp/#!/terms/licence-to-use-copernicus-products" class="external-link">Terms and conditions</a></li>
</ul>
<p>Next you can see your used id (UID) and API key on your account: <a href="https://cds.climate.copernicus.eu/user/" class="external-link uri">https://cds.climate.copernicus.eu/user/</a> . You need to manually set your account information in R using <code>wf_set_key</code> from the <code>ecmwfr</code> package with the service <code>'cds'</code>. Beware, you will need the <strong>ECMWF password</strong> to connect to Copernicus services with <code>wf_set_key</code>. Replace the user ID and API key in the following chunk and run it.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">wf_set_key</span><span class="op">(</span>user <span class="op">=</span> <span class="st">"******"</span>,</span>
<span>           key <span class="op">=</span> <span class="st">"********-****-****-****-************"</span>,</span>
<span>           service <span class="op">=</span> <span class="st">"cds"</span><span class="op">)</span></span></code></pre></div>
<p>You then define the location to retrieve climate data. Thanks to the function <code>getbb</code> from the package <code>osmdata</code> you can directly use the name of the entity, for example here the French Guiana for which the default species data have been initialized. We recommend using a large entity as the request preparation time is often longer than the resulting object to download (see estimates below for French Guiana).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">getbb</span><span class="op">(</span><span class="st">"French Guiana"</span>, format_out <span class="op">=</span> <span class="st">"sf_polygon"</span>, limit <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">multipolygon</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">addPolygons</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>you can then convert the coordinates into the desired request format with <code>gsub</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">","</span>, <span class="st">"/"</span>, <span class="fu">getbb</span><span class="op">(</span><span class="st">"French Guiana"</span>, format_out <span class="op">=</span> <span class="st">"string"</span>, limit <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>You need two types of product: (1) monthly averages by hour of day and (2) monthly averages at 00:00.</p>
<p>Now you can use the coordinates to build the request corresponding to the first set of data (monthly averages by hour of day) needed:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"dataset_short_name"</span> <span class="op">=</span> <span class="st">'reanalysis-era5-land-monthly-means'</span>,</span>
<span>  <span class="st">'format'</span><span class="op">=</span> <span class="st">'netcdf'</span>,</span>
<span>  <span class="st">'product_type'</span> <span class="op">=</span> <span class="st">'monthly_averaged_reanalysis_by_hour_of_day'</span>,</span>
<span>  <span class="st">"variable"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"10m_u_component_of_wind"</span>, <span class="st">"10m_v_component_of_wind"</span>, <span class="st">"2m_dewpoint_temperature"</span>,</span>
<span>                 <span class="st">"2m_temperature"</span>, <span class="st">"surface_pressure"</span>, <span class="st">"total_precipitation"</span><span class="op">)</span>,</span>
<span>  <span class="st">"month"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%02d"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>  <span class="st">"time"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%02d:00"</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">23</span><span class="op">)</span>,</span>
<span>  <span class="st">"year"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fl">2012</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span>,</span>
<span>  <span class="st">"target"</span> <span class="op">=</span> <span class="st">"ERA5land_hr_FG.nc"</span>,</span>
<span>  <span class="st">"area"</span> <span class="op">=</span> <span class="va">coords</span></span>
<span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p>The names of product and variables can be found directly on the Copernicus website.</p>
</blockquote>
<p>Finally you can use <code>wf_request</code> to download locally the request with the registered user id (UID):</p>
<p><strong>Request time:</strong></p>
<p><strong>Download size: 199.4 Mb</strong></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncfile</span> <span class="op">&lt;-</span> <span class="fu">wf_request</span><span class="op">(</span></span>
<span>  user <span class="op">=</span> <span class="st">"152268"</span>,</span>
<span>  request <span class="op">=</span> <span class="va">request</span>,   </span>
<span>  transfer <span class="op">=</span> <span class="cn">TRUE</span>,  </span>
<span>  path <span class="op">=</span> <span class="st">"."</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You can follow your request here : <a href="https://cds.climate.copernicus.eu/cdsapp#!/yourrequests" class="external-link uri">https://cds.climate.copernicus.eu/cdsapp#!/yourrequests</a> .</p>
<blockquote>
<p>As the resquest can be very long you can play with the <code>time_out</code> option in <code>wf_request</code>. By default it is set to 1 hour, but the request may take longer. We recommand either expanding the time out to expected request time, but you will block you R session (can be useful on cluster if you don’t want manual intervention). Or on the oppposite setting a short time out. Then <code>wf_request</code> is only used to make the request. And you can download later when ready your request on the Copernicus website (can be useful on local session to avoid blocking the rsession).</p>
</blockquote>
<p>You can do the same for the second set of data (monthly averages) needed:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"dataset_short_name"</span> <span class="op">=</span> <span class="st">'reanalysis-era5-land-monthly-means'</span>,</span>
<span>  <span class="st">'format'</span><span class="op">=</span> <span class="st">'netcdf'</span>,</span>
<span>  <span class="st">'product_type'</span> <span class="op">=</span> <span class="st">'monthly_averaged_reanalysis'</span>, <span class="st">"time"</span> <span class="op">=</span> <span class="st">"00:00"</span>,</span>
<span>  <span class="st">"variable"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"10m_u_component_of_wind"</span>, <span class="st">"10m_v_component_of_wind"</span>, <span class="st">"2m_dewpoint_temperature"</span>,</span>
<span>                 <span class="st">"2m_temperature"</span>, <span class="st">"surface_pressure"</span>, <span class="st">"total_precipitation"</span><span class="op">)</span>,</span>
<span>  <span class="st">"month"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%02d"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>  <span class="st">"time"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%02d:00"</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">23</span><span class="op">)</span>,</span>
<span>  <span class="st">"year"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fl">2012</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span>,</span>
<span>  <span class="st">"target"</span> <span class="op">=</span> <span class="st">"ERA5land_mth_FG.nc"</span>,</span>
<span>  <span class="st">"area"</span> <span class="op">=</span> <span class="va">coords</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Finally you can use <code>wf_request</code> to download locally the request with the registered user id (UID):</p>
<p><strong>Request time:</strong></p>
<p><strong>Download size: 9.1 Mb</strong></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncfile</span> <span class="op">&lt;-</span> <span class="fu">wf_request</span><span class="op">(</span></span>
<span>  user <span class="op">=</span> <span class="st">"152268"</span>,</span>
<span>  request <span class="op">=</span> <span class="va">request</span>,   </span>
<span>  transfer <span class="op">=</span> <span class="cn">TRUE</span>,  </span>
<span>  path <span class="op">=</span> <span class="st">"."</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="have-a-look-to-the-downloaded-data">Have a look to the downloaded data<a class="anchor" aria-label="anchor" href="#have-a-look-to-the-downloaded-data"></a>
</h2>
<p>You can have a look to the resulting ERA5 land data. First extract the chosen value in your file, for instance here total precipitation <code>tp</code> and consolidate the data as a table using <code>dplyr</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"ERA5land_mth_FG.nc"</span>, <span class="st">"tp"</span><span class="op">)</span></span>
<span><span class="va">test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">test_r</span>, xy <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="st">"variable"</span>, <span class="st">"value"</span>, <span class="op">-</span><span class="va">x</span> , <span class="op">-</span><span class="va">y</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html" class="external-link">separate</a></span><span class="op">(</span><span class="va">variable</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"variable"</span>, <span class="st">"t"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">test_r</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html" class="external-link">spread</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">value</span><span class="op">)</span></span></code></pre></div>
<p>You can then plot the result as a static figure for a chosen year and month using <code>ggplot</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">test</span>, <span class="va">t</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, fill <span class="op">=</span> <span class="va">tp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu">spData</span><span class="fu">::</span><span class="va">world</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="st">"Total\nprecipitation"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">54.6026945</span>,<span class="op">-</span><span class="fl">51.6346139</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.1109401</span>,<span class="fl">5.7769491</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Longitue"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Latitude"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">test</span>, <span class="va">t</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">date</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Or as a dynamic gif using <code>gganimate</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, month <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html" class="external-link">floor_date</a></span><span class="op">(</span><span class="va">date</span>, <span class="st">'month'</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>tp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">tp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, fill <span class="op">=</span> <span class="va">tp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu">spData</span><span class="fu">::</span><span class="va">world</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="st">"Total\nprecipitation\n"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">54.6026945</span>,<span class="op">-</span><span class="fl">51.6346139</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.1109401</span>,<span class="fl">5.7769491</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Longitue"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Latitude"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Month: {frame_time}'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://gganimate.com/reference/transition_time.html" class="external-link">transition_time</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prepare-troll-inputs">Prepare TROLL inputs<a class="anchor" aria-label="anchor" href="#prepare-troll-inputs"></a>
</h2>
<p>Next you need coordinates of the location where you want to run your TROLL simulations to extract the data from downloaded ERA5-land data to TROLL climate data. We will use here the coordinates from the Reserve naturelle des Nouragues where the functional data have been partly collected from. For that <code>nominatimlite</code> provide a useful function called <code>geo_lite_sf</code> to easily geocode locations:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">geo_lite_sf</span><span class="op">(</span><span class="st">"Réserve naturelle des nouragues, 97301, Régina"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">addPolygons</span><span class="op">(</span>data <span class="op">=</span>  <span class="fu">getbb</span><span class="op">(</span><span class="st">"French Guiana"</span>, format_out <span class="op">=</span> <span class="st">"sf_polygon"</span>, limit <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">multipolygon</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">addCircleMarkers</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p>You can extract corresponding coordinates using <code>st_coordinates</code> from <code>sf</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu">geo_lite_sf</span><span class="op">(</span><span class="st">"Réserve naturelle des nouragues, 97301, Régina"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">st_coordinates</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>You will also need the corresponding time zone for time correction as ERA5-land is giving us time in UTC. For that you can use the <code>tz_lookup_coords</code> function from the package <code>lutz</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">tz</span> <span class="op">&lt;-</span> <span class="fu">lutz</span><span class="fu">::</span><span class="fu">tz_lookup_coords</span><span class="op">(</span>lon <span class="op">=</span> <span class="va">coords</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, lat <span class="op">=</span> <span class="va">coords</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, method <span class="op">=</span> <span class="st">"accurate"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>You can use the <code>generate_cliamte</code> function inside TROLL to prepare <code>TROLL</code> climatic data:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">climate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_climate.html">generate_climate</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">coords</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, tz <span class="op">=</span> <span class="va">tz</span>,</span>
<span>                            era5land_hour <span class="op">=</span> <span class="st">"ERA5land_hr_FG.nc"</span>, era5land_month <span class="op">=</span> <span class="st">"ERA5land_mth_FG.nc"</span><span class="op">)</span></span></code></pre></div>
<p>And as expected you obtain inputs ready to run models :</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">climate</span><span class="op">$</span><span class="va">daytimevar</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">climate</span><span class="op">$</span><span class="va">climatedaytime12</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This is only R objects. <code>generate_climate</code> is running fast. But in case you want to run multiple simulations at the same location we recommend saving the corresponding files for later:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">write_tsv</span><span class="op">(</span><span class="va">climate</span><span class="op">$</span><span class="va">daytimevar</span>, <span class="st">"ERA5land_daytimevar.txt"</span><span class="op">)</span></span>
<span><span class="fu">write_tsv</span><span class="op">(</span><span class="va">climate</span><span class="op">$</span><span class="va">climatedaytime12</span>, <span class="st">"ERA5land_climatedaytime12.txt"</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Sylvain Schmitt.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
